-- ======================================================
-- SCRIPT UNIFICADO DE BANCO DE DADOS - TALENTMIND GS
-- ======================================================

-- 1. CRIAÇÃO DAS TABELAS (V1)
CREATE TABLE T_USUARIO (
    ID_USUARIO          NUMBER          GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NOME_USUARIO        VARCHAR2(150)   NOT NULL,
    EMAIL_USUARIO       VARCHAR2(100)   NOT NULL,
    SENHA_USUARIO       VARCHAR2(100)   NOT NULL,
    DT_CADASTRO         DATE            DEFAULT SYSDATE,
    ROLE                VARCHAR2(20)    DEFAULT 'USER' NOT NULL,
    CONSTRAINT PK_USUARIO PRIMARY KEY (ID_USUARIO),
    CONSTRAINT UK_USUARIO_EMAIL UNIQUE (EMAIL_USUARIO)
);

CREATE TABLE T_COMPETENCIA (
    ID_COMPETENCIA      NUMBER          GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NOME_COMPETENCIA    VARCHAR2(100)   NOT NULL,
    DESCRICAO_COMP      VARCHAR2(300),
    CONSTRAINT PK_COMPETENCIA PRIMARY KEY (ID_COMPETENCIA),
    CONSTRAINT UK_COMPETENCIA_NOME UNIQUE (NOME_COMPETENCIA)
);

CREATE TABLE T_VAGA (
    ID_VAGA             NUMBER          GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    TITULO_VAGA         VARCHAR2(150)   NOT NULL,
    DESCRICAO_VAGA      VARCHAR2(1000)  NOT NULL,
    EMPRESA_VAGA        VARCHAR2(100),
    SALARIO_MEDIO       NUMBER(10, 2),
    DT_PUBLICACAO       DATE            DEFAULT SYSDATE,
    CONSTRAINT PK_VAGA PRIMARY KEY (ID_VAGA)
);

CREATE TABLE T_CURSO_REQUALIFICACAO (
    ID_CURSO            NUMBER          GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NOME_CURSO          VARCHAR2(200)   NOT NULL,
    INSTITUICAO_CURSO   VARCHAR2(100),
    LINK_CURSO          VARCHAR2(255),
    CONSTRAINT PK_CURSO PRIMARY KEY (ID_CURSO)
);

CREATE TABLE T_USUARIO_COMPETENCIA (
    ID_USUARIO          NUMBER          NOT NULL,
    ID_COMPETENCIA      NUMBER          NOT NULL,
    NIVEL_COMPETENCIA   VARCHAR2(50),
    CONSTRAINT PK_USUARIO_COMP PRIMARY KEY (ID_USUARIO, ID_COMPETENCIA),
    CONSTRAINT FK_USU_COMP_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES T_USUARIO (ID_USUARIO) ON DELETE CASCADE,
    CONSTRAINT FK_USU_COMP_COMP FOREIGN KEY (ID_COMPETENCIA) REFERENCES T_COMPETENCIA (ID_COMPETENCIA) ON DELETE CASCADE
);

CREATE TABLE T_VAGA_COMPETENCIA (
    ID_VAGA             NUMBER          NOT NULL,
    ID_COMPETENCIA      NUMBER          NOT NULL,
    CONSTRAINT PK_VAGA_COMP PRIMARY KEY (ID_VAGA, ID_COMPETENCIA),
    CONSTRAINT FK_VAGA_COMP_VAGA FOREIGN KEY (ID_VAGA) REFERENCES T_VAGA (ID_VAGA) ON DELETE CASCADE,
    CONSTRAINT FK_VAGA_COMP_COMP FOREIGN KEY (ID_COMPETENCIA) REFERENCES T_COMPETENCIA (ID_COMPETENCIA) ON DELETE CASCADE
);

CREATE TABLE T_CURSO_COMPETENCIA (
    ID_CURSO            NUMBER          NOT NULL,
    ID_COMPETENCIA      NUMBER          NOT NULL,
    CONSTRAINT PK_CURSO_COMP PRIMARY KEY (ID_CURSO, ID_COMPETENCIA),
    CONSTRAINT FK_CURSO_COMP_CURSO FOREIGN KEY (ID_CURSO) REFERENCES T_CURSO_REQUALIFICACAO (ID_CURSO) ON DELETE CASCADE,
    CONSTRAINT FK_CURSO_COMP_COMP FOREIGN KEY (ID_COMPETENCIA) REFERENCES T_COMPETENCIA (ID_COMPETENCIA) ON DELETE CASCADE
);

CREATE TABLE T_AUDITORIA_TRANSACOES (
    ID_AUDITORIA        NUMBER          GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NOME_TABELA         VARCHAR2(50)    NOT NULL,
    OPERACAO            VARCHAR2(10)    NOT NULL,
    USUARIO_DB          VARCHAR2(50)    NOT NULL,
    DT_OPERACAO         DATE            DEFAULT SYSDATE,
    DADOS_ANTIGOS       CLOB,
    DADOS_NOVOS         CLOB,
    CONSTRAINT PK_AUDITORIA PRIMARY KEY (ID_AUDITORIA)
);

-- 2. PACOTES E PROCEDURES (V2)
/
CREATE OR REPLACE PACKAGE PKG_DASHBOARD_INSERTS AS
    PROCEDURE PRC_INS_USUARIO (p_nome_usuario IN T_USUARIO.NOME_USUARIO%TYPE, p_email_usuario IN T_USUARIO.EMAIL_USUARIO%TYPE, p_senha_usuario IN T_USUARIO.SENHA_USUARIO%TYPE, p_role_usuario IN T_USUARIO.ROLE%TYPE DEFAULT 'USER', p_id_out OUT T_USUARIO.ID_USUARIO%TYPE);
    PROCEDURE PRC_INS_COMPETENCIA (p_nome_comp IN T_COMPETENCIA.NOME_COMPETENCIA%TYPE, p_descricao_comp IN T_COMPETENCIA.DESCRICAO_COMP%TYPE, p_id_out OUT T_COMPETENCIA.ID_COMPETENCIA%TYPE);
    PROCEDURE PRC_INS_VAGA (p_titulo_vaga IN T_VAGA.TITULO_VAGA%TYPE, p_descricao_vaga IN T_VAGA.DESCRICAO_VAGA%TYPE, p_empresa_vaga IN T_VAGA.EMPRESA_VAGA%TYPE, p_salario_medio IN T_VAGA.SALARIO_MEDIO%TYPE, p_id_out OUT T_VAGA.ID_VAGA%TYPE);
    PROCEDURE PRC_INS_CURSO (p_nome_curso IN T_CURSO_REQUALIFICACAO.NOME_CURSO%TYPE, p_instituicao_curso IN T_CURSO_REQUALIFICACAO.INSTITUICAO_CURSO%TYPE, p_link_curso IN T_CURSO_REQUALIFICACAO.LINK_CURSO%TYPE, p_id_out OUT T_CURSO_REQUALIFICACAO.ID_CURSO%TYPE);
    PROCEDURE PRC_INS_USUARIO_COMP (p_id_usuario IN T_USUARIO_COMPETENCIA.ID_USUARIO%TYPE, p_id_competencia IN T_USUARIO_COMPETENCIA.ID_COMPETENCIA%TYPE, p_nivel_competencia IN T_USUARIO_COMPETENCIA.NIVEL_COMPETENCIA%TYPE);
    PROCEDURE PRC_INS_VAGA_COMP (p_id_vaga IN T_VAGA_COMPETENCIA.ID_VAGA%TYPE, p_id_competencia IN T_VAGA_COMPETENCIA.ID_COMPETENCIA%TYPE);
    PROCEDURE PRC_INS_CURSO_COMP (p_id_curso IN T_CURSO_COMPETENCIA.ID_CURSO%TYPE, p_id_competencia IN T_CURSO_COMPETENCIA.ID_COMPETENCIA%TYPE);
END PKG_DASHBOARD_INSERTS;
/
CREATE OR REPLACE PACKAGE BODY PKG_DASHBOARD_INSERTS AS
    PROCEDURE PRC_INS_USUARIO (p_nome_usuario IN T_USUARIO.NOME_USUARIO%TYPE, p_email_usuario IN T_USUARIO.EMAIL_USUARIO%TYPE, p_senha_usuario IN T_USUARIO.SENHA_USUARIO%TYPE, p_role_usuario IN T_USUARIO.ROLE%TYPE DEFAULT 'USER', p_id_out OUT T_USUARIO.ID_USUARIO%TYPE) AS BEGIN INSERT INTO T_USUARIO (NOME_USUARIO, EMAIL_USUARIO, SENHA_USUARIO, ROLE) VALUES (p_nome_usuario, p_email_usuario, p_senha_usuario, p_role_usuario) RETURNING ID_USUARIO INTO p_id_out; END;
    PROCEDURE PRC_INS_COMPETENCIA (p_nome_comp IN T_COMPETENCIA.NOME_COMPETENCIA%TYPE, p_descricao_comp IN T_COMPETENCIA.DESCRICAO_COMP%TYPE, p_id_out OUT T_COMPETENCIA.ID_COMPETENCIA%TYPE) AS BEGIN INSERT INTO T_COMPETENCIA (NOME_COMPETENCIA, DESCRICAO_COMP) VALUES (p_nome_comp, p_descricao_comp) RETURNING ID_COMPETENCIA INTO p_id_out; END;
    PROCEDURE PRC_INS_VAGA (p_titulo_vaga IN T_VAGA.TITULO_VAGA%TYPE, p_descricao_vaga IN T_VAGA.DESCRICAO_VAGA%TYPE, p_empresa_vaga IN T_VAGA.EMPRESA_VAGA%TYPE, p_salario_medio IN T_VAGA.SALARIO_MEDIO%TYPE, p_id_out OUT T_VAGA.ID_VAGA%TYPE) AS BEGIN INSERT INTO T_VAGA (TITULO_VAGA, DESCRICAO_VAGA, EMPRESA_VAGA, SALARIO_MEDIO) VALUES (p_titulo_vaga, p_descricao_vaga, p_empresa_vaga, p_salario_medio) RETURNING ID_VAGA INTO p_id_out; END;
    PROCEDURE PRC_INS_CURSO (p_nome_curso IN T_CURSO_REQUALIFICACAO.NOME_CURSO%TYPE, p_instituicao_curso IN T_CURSO_REQUALIFICACAO.INSTITUICAO_CURSO%TYPE, p_link_curso IN T_CURSO_REQUALIFICACAO.LINK_CURSO%TYPE, p_id_out OUT T_CURSO_REQUALIFICACAO.ID_CURSO%TYPE) AS BEGIN INSERT INTO T_CURSO_REQUALIFICACAO (NOME_CURSO, INSTITUICAO_CURSO, LINK_CURSO) VALUES (p_nome_curso, p_instituicao_curso, p_link_curso) RETURNING ID_CURSO INTO p_id_out; END;
    PROCEDURE PRC_INS_USUARIO_COMP (p_id_usuario IN T_USUARIO_COMPETENCIA.ID_USUARIO%TYPE, p_id_competencia IN T_USUARIO_COMPETENCIA.ID_COMPETENCIA%TYPE, p_nivel_competencia IN T_USUARIO_COMPETENCIA.NIVEL_COMPETENCIA%TYPE) AS BEGIN INSERT INTO T_USUARIO_COMPETENCIA (ID_USUARIO, ID_COMPETENCIA, NIVEL_COMPETENCIA) VALUES (p_id_usuario, p_id_competencia, p_nivel_competencia); END;
    PROCEDURE PRC_INS_VAGA_COMP (p_id_vaga IN T_VAGA_COMPETENCIA.ID_VAGA%TYPE, p_id_competencia IN T_VAGA_COMPETENCIA.ID_COMPETENCIA%TYPE) AS BEGIN INSERT INTO T_VAGA_COMPETENCIA (ID_VAGA, ID_COMPETENCIA) VALUES (p_id_vaga, p_id_competencia); END;
    PROCEDURE PRC_INS_CURSO_COMP (p_id_curso IN T_CURSO_COMPETENCIA.ID_CURSO%TYPE, p_id_competencia IN T_CURSO_COMPETENCIA.ID_COMPETENCIA%TYPE) AS BEGIN INSERT INTO T_CURSO_COMPETENCIA (ID_CURSO, ID_COMPETENCIA) VALUES (p_id_curso, p_id_competencia); END;
END PKG_DASHBOARD_INSERTS;
/

CREATE OR REPLACE PACKAGE PKG_DASHBOARD_FUNCTIONS AS
    FUNCTION FN_GET_USUARIO_JSON (p_id_usuario IN T_USUARIO.ID_USUARIO%TYPE) RETURN CLOB;
    FUNCTION FN_VALIDA_EMAIL (p_email IN VARCHAR2) RETURN BOOLEAN;
    FUNCTION FN_CALC_COMPATIBILIDADE (p_id_usuario IN T_USUARIO.ID_USUARIO%TYPE, p_id_vaga IN T_VAGA.ID_VAGA%TYPE) RETURN NUMBER;
    PROCEDURE PRC_EXPORTA_DATASET_JSON (p_dataset_json OUT CLOB);
END PKG_DASHBOARD_FUNCTIONS;
/
CREATE OR REPLACE PACKAGE BODY PKG_DASHBOARD_FUNCTIONS AS
    FUNCTION FN_GET_USUARIO_JSON (p_id_usuario IN T_USUARIO.ID_USUARIO%TYPE) RETURN CLOB AS v_json_clob CLOB; v_usuario T_USUARIO%ROWTYPE; BEGIN SELECT * INTO v_usuario FROM T_USUARIO WHERE ID_USUARIO = p_id_usuario; v_json_clob := '{"id": ' || v_usuario.ID_USUARIO || '}'; RETURN v_json_clob; EXCEPTION WHEN OTHERS THEN RETURN '{}'; END;
    FUNCTION FN_VALIDA_EMAIL (p_email IN VARCHAR2) RETURN BOOLEAN AS BEGIN RETURN REGEXP_LIKE(p_email, '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'); END;
    FUNCTION FN_CALC_COMPATIBILIDADE (p_id_usuario IN T_USUARIO.ID_USUARIO%TYPE, p_id_vaga IN T_VAGA.ID_VAGA%TYPE) RETURN NUMBER AS BEGIN RETURN 0; END; -- Simplificado para script único
    PROCEDURE PRC_EXPORTA_DATASET_JSON (p_dataset_json OUT CLOB) AS BEGIN p_dataset_json := '{}'; END;
END PKG_DASHBOARD_FUNCTIONS;
/

-- 3. TRIGGERS DE AUDITORIA (V3)
CREATE OR REPLACE TRIGGER TRG_AUDIT_USUARIO AFTER INSERT OR UPDATE OR DELETE ON T_USUARIO FOR EACH ROW BEGIN INSERT INTO T_AUDITORIA_TRANSACOES (NOME_TABELA, OPERACAO, USUARIO_DB, DADOS_NOVOS) VALUES ('T_USUARIO', CASE WHEN INSERTING THEN 'INSERT' WHEN UPDATING THEN 'UPDATE' ELSE 'DELETE' END, USER, 'ID: ' || :NEW.ID_USUARIO); END;
/
CREATE OR REPLACE TRIGGER TRG_AUDIT_VAGA AFTER INSERT OR UPDATE OR DELETE ON T_VAGA FOR EACH ROW BEGIN INSERT INTO T_AUDITORIA_TRANSACOES (NOME_TABELA, OPERACAO, USUARIO_DB, DADOS_NOVOS) VALUES ('T_VAGA', CASE WHEN INSERTING THEN 'INSERT' WHEN UPDATING THEN 'UPDATE' ELSE 'DELETE' END, USER, 'ID: ' || :NEW.ID_VAGA); END;
/

-- 4. CARGA DE DADOS INICIAL (V4)
DECLARE
    v_id_dummy NUMBER;
    v_senha_padrao VARCHAR2(100) := '$2a$10$f/TALbM3.Vq3.EHr4kvzO.3v/S3/oSUg1EN1j1.1thAOGnBv0B.qG'; -- "password"
BEGIN
    -- Admin
    PKG_DASHBOARD_INSERTS.PRC_INS_USUARIO('Administrador', 'admin@talentmind.com', v_senha_padrao, 'ADMIN', v_id_dummy);
    -- Dados de Exemplo
    PKG_DASHBOARD_INSERTS.PRC_INS_COMPETENCIA('IA Generativa', 'Uso de LLMs', v_id_dummy);
    PKG_DASHBOARD_INSERTS.PRC_INS_COMPETENCIA('Java', 'Spring Boot', v_id_dummy);
    COMMIT;
END;
/